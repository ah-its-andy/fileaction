name: convert-jpeg-to-heic
description: Convert JPEG images to HEIC format using ImageMagick
on:
  paths:
    - ./library/images
convert:
  from: jpeg
  to: heic
steps:
  - name: check-input
    run: |
      # Check if input file exists and is valid
      if [ ! -f "${{ input_path }}" ]; then
        echo "Error: Input file does not exist"
        exit 101
      fi
      
      # Check if output already exists and is newer than input
      if [ -f "${{ output_path }}" ]; then
        if [ "${{ output_path }}" -nt "${{ input_path }}" ]; then
          echo "Output file already exists and is up-to-date, skipping conversion"
          exit 100
        fi
        echo "Output exists but is older, will re-convert"
      fi
      
      echo "Input file is valid, proceeding with conversion"
      
  - name: imagemagick-convert
    run: magick "${{ input_path }}" -quality 100 "${{ output_path }}"
    env:
      MAGICK_THREAD_LIMIT: "1"
      
  - name: verify-conversion
    run: |
      # Check if output file exists and has size > 0
      if [ ! -s "${{ output_path }}" ]; then
        echo "Error: Output file does not exist or is empty"
        exit 1
      fi
      # Use file command to check format (HEIC files may be reported as ISO Media or HEIF)
      file_type=$(file "${{ output_path }}")
      echo "File type: $file_type"
      if echo "$file_type" | grep -qiE "HEIC|HEIF|ISO Media.*HEVC"; then
        echo "Verification passed: File is in HEIC/HEIF format"
        exit 0
      else
        echo "Warning: Could not verify HEIC format, but file exists"
        exit 0
      fi
options:
  concurrency: 2
  include_subdirs: true
  file_glob: "*.jpg,*.jpeg"
  skip_on_nochange: true
  output_dir_pattern: "../heic"
  ignore:
    - ".DS_Store"
    - "Thumbs.db"
    - "*.tmp"
    - "**/temp/**"
    - "**/.git/**"
    - ".@__thumb"
    - ".@__macos"
    - "**/.@__thumb/**"
    - "**/.@__macos/**"