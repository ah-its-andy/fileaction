name: jpeg-to-heic-converter
description: Convert JPEG images to HEIC format using ImageMagick
version: 1.0.0
dependencies:
  - magick
inputs:
  quality:
    type: number
    default: 100
    required: false
    description: "Output quality (1-100)"
  skip_existing:
    type: boolean
    default: true
    required: false
    description: "Skip conversion if output exists and is newer"
steps:
  - name: check-input
    run: |
      # Check if input file exists and is valid
      if [ ! -f "${{ input_path }}" ]; then
        echo "Error: Input file does not exist"
        exit 101
      fi
      
      # Check if output already exists and is newer than input (if enabled)
      if [ "${{ inputs.skip_existing }}" = "true" ]; then
        if [ -f "${{ output_path }}" ]; then
          if [ "${{ output_path }}" -nt "${{ input_path }}" ]; then
            echo "Output file already exists and is up-to-date, skipping conversion"
            exit 100
          fi
          echo "Output exists but is older, will re-convert"
        fi
      fi
      
      echo "Input file is valid, proceeding with conversion"
      
  - name: imagemagick-convert
    run: magick "${{ input_path }}" -quality ${{ inputs.quality }} "${{ output_path }}"
    env:
      MAGICK_THREAD_LIMIT: "1"
      
  - name: verify-conversion
    run: |
      # Check if output file exists and has size > 0
      if [ ! -s "${{ output_path }}" ]; then
        echo "Error: Output file does not exist or is empty"
        exit 1
      fi
      # Use file command to check format (HEIC files may be reported as ISO Media or HEIF)
      file_type=$(file "${{ output_path }}")
      echo "File type: $file_type"
      if echo "$file_type" | grep -qiE "HEIC|HEIF|ISO Media.*HEVC"; then
        echo "Verification passed: File is in HEIC/HEIF format"
        exit 0
      else
        echo "Warning: Could not verify HEIC format, but file exists"
        exit 0
      fi
tags:
  - image
  - conversion
  - heic
